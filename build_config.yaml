---
# VexRiscv Verification Framework - Build Configuration
# Author: Vaishnav Prasad R K
# Updated: 2025-11-01

project:
  name: VexRiscv Verification Framework
  description: RTL, Whisper, and RISC-V DV integration

tasks:
  deps:
    description: "Install base toolchain (Java, sbt, Python, build tools)"
    dependencies: []
    steps:
      - name: "Check Java 8"
        command: "command -v java >/dev/null 2>&1 && java -version 2>&1 | grep -q '1\\.8'"
        on_success: "echo '[OK] Java 8 already installed.'"
        on_failure: "sudo apt-get update -qq && sudo apt-get install -y openjdk-8-jdk"

      - name: "Check sbt"
        command: "command -v sbt >/dev/null 2>&1"
        on_success: "echo '[OK] sbt already installed.'"
        on_failure: |
          sudo apt-get install -y curl apt-transport-https gnupg && \
          echo "deb https://repo.scala-sbt.org/scalasbt/debian all main" | sudo tee /etc/apt/sources.list.d/sbt.list && \
          curl -sL "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x2EE0EA64E40A89B84B2DF73499E82A75642AC823" | sudo apt-key add - && \
          sudo apt-get update -qq && sudo apt-get install -y sbt

      - name: "Check Python3"
        command: "command -v python3 >/dev/null 2>&1"
        on_success: "echo '[OK] Python3 installed.'"
        on_failure: "sudo apt-get install -y python3 python3-pip"

  rtl-gen:
    description: "Generate VexRiscv RTL via SpinalHDL"
    dependencies: [deps]
    steps:
      - name: "Check VexRiscv directory"
        command: "[ -d 'rtl/VexRiscv' ]"
        on_failure: "echo '[ERROR] rtl/VexRiscv not found. Initialize submodules first.' && exit 1"

      - name: "Generate RTL"
        command: "cd rtl/VexRiscv && sbt 'runMain vexriscv.demo.GenFull'"

  whisper:
    description: "Build Tenstorrent Whisper simulator"
    dependencies: [deps]
    steps:
      - name: "Install dependencies"
        command: "true"
        actions:
          - "sudo apt-get install -y g++-11 build-essential libboost-all-dev gcc-riscv64-unknown-elf liblz4-dev libvncserver-dev"

      - name: "Check Whisper directory"
        command: "[ -d 'tools/whisper' ]"
        on_failure: "echo '[ERROR] tools/whisper not found. Run: git submodule update --init --recursive' && exit 1"

      - name: "Build Whisper"
        command: "cd tools/whisper && make BOOST_DIR=/usr"

  riscv-dv:
    description: "Install ChipsAlliance RISC-V DV framework"
    dependencies: [deps]
    steps:
      - name: "Check RISC-V DV directory"
        command: "[ -d 'tools/riscv-dv' ]"
        on_failure: "echo '[ERROR] tools/riscv-dv not found. Run: git submodule update --init --recursive' && exit 1"

      - name: "Install Python requirements"
        command: "cd tools/riscv-dv && pip3 install --user -r requirements.txt"

      - name: "Install in editable mode"
        command: "cd tools/riscv-dv && export PATH=$$HOME/.local/bin:$$PATH && pip3 install --user -e ."

  riscv-dv-gen:
    description: "Generate random RISC-V DV instruction tests"
    dependencies: [riscv-dv]
    steps:
      - name: "Check RISC-V DV directory"
        command: "[ -d 'tools/riscv-dv' ]"
        on_failure: "echo '[ERROR] tools/riscv-dv not found.' && exit 1"

      - name: "Generate tests"
        command: "cd tools/riscv-dv && run --test riscv_rand_instr_test --iterations 50 --output ../../tests/generated"

  style-check:
    description: "Run Verilog style checks using Verible"
    dependencies: [riscv-dv]
    steps:
      - name: "Check RISC-V DV directory"
        command: "[ -d 'tools/riscv-dv' ]"
        on_failure: "echo '[ERROR] tools/riscv-dv not found.' && exit 1"

      - name: "Run style check"
        command: "cd tools/riscv-dv/verilog_style && ./build-verible.sh && ./run.sh"

  clean:
    description: "Remove build artifacts"
    dependencies: []
    steps:
      - name: "Clean VexRiscv"
        command: "[ -d 'rtl/VexRiscv' ] && cd rtl/VexRiscv && sbt clean || true"

      - name: "Clean Whisper"
        command: "[ -d 'tools/whisper/build-Linux' ] && rm -rf tools/whisper/build-Linux || true"

      - name: "Clean tests"
        command: "[ -d 'tests/generated' ] && rm -rf tests/generated || true"

  check:
    description: "Show current toolchain versions"
    dependencies: []
    steps:
      - name: "Java version"
        command: "java -version 2>&1 | head -n 1 || echo 'Java missing'"

      - name: "sbt version"
        command: "sbt sbtVersion 2>&1 | head -n 1 || echo 'sbt missing'"

      - name: "Python version"
        command: "python3 --version || echo 'Python3 missing'"

      - name: "g++ version"
        command: "g++-11 --version 2>&1 | head -n 1 || echo 'g++-11 missing'"

      - name: "RISC-V GCC version"
        command: "riscv64-unknown-elf-gcc --version 2>&1 | head -n 1 || echo 'RISC-V GCC missing'"

      - name: "Boost library"
        command: "dpkg -l 2>/dev/null | grep libboost | head -n 1 || echo 'Boost missing'"

  all:
    description: "Run full build pipeline (deps + rtl-gen)"
    dependencies: [deps, rtl-gen]
    steps: []