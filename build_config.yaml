# ---------------------------------------------------------
# VexRiscv Build Configuration (YAML version of Makefile)
# ---------------------------------------------------------
# Author: Vaishnav Prasad R K
# Date: 2025-11-12

project:
  name: VexRiscv Verification Build
  description: Automated build system mirroring original Makefile flow

tasks:
  deps:
    description: "Check and install Java, sbt, Python3, and base build tools"
    dependencies: []
    steps:
      - name: "Check Java 8"
        command: "command -v java >/dev/null 2>&1 && java -version 2>&1 | grep -q '1\\.8'"
        on_success: "echo '[OK] Java 8 already installed.'"
        on_failure: |
          echo '[INFO] Installing OpenJDK 8...' && \
          sudo apt-get update -qq && sudo apt-get install -y openjdk-8-jdk

      - name: "Check sbt"
        command: "command -v sbt >/dev/null 2>&1"
        on_success: "echo '[OK] sbt already installed.'"
        on_failure: |
          echo '[INFO] Installing sbt...' && \
          sudo apt-get install -y curl apt-transport-https gnupg && \
          echo 'deb https://repo.scala-sbt.org/scalasbt/debian all main' | sudo tee /etc/apt/sources.list.d/sbt.list && \
          curl -sL 'https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x2EE0EA64E40A89B84B2DF73499E82A75642AC823' | sudo apt-key add - && \
          sudo apt-get update -qq && sudo apt-get install -y sbt

      - name: "Check Python3"
        command: "command -v python3 >/dev/null 2>&1"
        on_success: "echo '[OK] Python3 installed.'"
        on_failure: |
          echo '[INFO] Installing Python3...' && \
          sudo apt-get install -y python3 python3-pip

  rtl-gen:
    description: "Generate VexRiscv RTL"
    dependencies: [deps]
    steps:
      - name: "Check RTL directory"
        command: "[ -d 'rtl/VexRiscv' ]"
        on_failure: "echo '[ERROR] rtl/VexRiscv not found. Initialize submodules first.' && exit 1"

      - name: "Run sbt RTL generation"
        command: "cd rtl/VexRiscv && sbt 'runMain vexriscv.demo.GenFull'"

  whisper:
    description: "Build Tenstorrent Whisper"
    dependencies: []
    steps:
      - name: "Install Whisper dependencies"
        command: |
          sudo apt-get install -y g++-11 build-essential gcc-riscv64-unknown-elf liblz4-dev libvncserver-dev wget tar

      - name: "Check Whisper directory"
        command: "[ -d 'tools/whisper' ]"
        on_failure: "echo '[ERROR] tools/whisper not found. Run: git submodule update --init --recursive' && exit 1"

      - name: "Download and build Boost"
        command: |
          cd tools/whisper && \
          if [ ! -d 'boost' ]; then \
            echo '=== [Whisper] Downloading Boost 1.83.0 ==='; \
            wget -q https://archives.boost.io/release/1.83.0/source/boost_1_83_0.tar.gz -O boost_1_83_0.tar.gz; \
            tar -xzf boost_1_83_0.tar.gz; \
            mv boost_1_83_0 boost; \
            rm -f boost_1_83_0.tar.gz; \
            cd boost; \
            ./bootstrap.sh --prefix=$(pwd)/install; \
            ./b2 install --with-system --with-filesystem --with-thread --with-program_options --with-chrono --with-date_time --with-regex -j$(nproc); \
          else \
            echo '=== [Whisper] Boost already built, skipping download ==='; \
          fi

      - name: "Build Whisper"
        command: "cd tools/whisper && make BOOST_DIR=$(pwd)/boost/install"

  riscv-dv:
    description: "Set up RISC-V DV verification environment"
    dependencies: []
    steps:
      - name: "Create virtual environment"
        command: "cd tools/riscv-dv && python3 -m venv .venv"

      - name: "Install dependencies"
        command: "cd tools/riscv-dv && . .venv/bin/activate && pip install --upgrade pip && pip install -r requirements.txt"

      - name: "Install in editable mode"
        command: "cd tools/riscv-dv && . .venv/bin/activate && pip install -e ."

  riscv-dv-gen:
    description: "Generate random instruction tests using RISC-V DV"
    dependencies: [riscv-dv]
    steps:
      - name: "Check riscv-dv directory"
        command: "[ -d 'tools/riscv-dv' ]"
        on_failure: "echo '[ERROR] tools/riscv-dv not found.' && exit 1"

      - name: "Generate random tests"
        command: |
          cd tools/riscv-dv && \
          python3 run.py \
            --test riscv_rand_instr_test \
            --iterations 50 \
            --output ../../regression/testcases/generated \
            -si 'questa' \
            --steps gen
